<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Share Approx Location (Silent)</title>
  <style>
    body{font-family:system-ui,Arial;padding:32px;background:#f3f4f6}
    .card{max-width:480px;margin:40px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06);text-align:center}
    button{padding:12px 18px;border-radius:10px;border:0;cursor:pointer;background:#2563eb;color:#fff}
    .msg{margin-top:12px;color:#334155}
  </style>
</head>
<body>
  <div class="card">
    <h2>Share approximate location</h2>
    <p>This will send a coarse (IP-based) location to the server â€” no browser permission will appear.</p>
    <button id="share">Share my approximate location (silent)</button>
    <div id="msg" class="msg"></div>
  </div>

  <script>
    const btn = document.getElementById('share');
    const msg = document.getElementById('msg');

    btn.addEventListener('click', async () => {
      msg.textContent = 'Contacting server to get approximate location...';
      btn.disabled = true;

      try {
        // POST to server endpoint which will detect the IP and fetch IP-based geo
        const resp = await fetch('/silent-location', { method: 'POST' });
        if (!resp.ok) throw new Error('Server returned ' + resp.status);
        const data = await resp.json();

        // data will include city/region/country and mapUrl if server built one
        msg.innerHTML = `Approx location: ${data.city || 'unknown'}, ${data.regionName || ''} ${data.country || ''}<br/>Redirecting...`;

        // Redirect to a target URL returned by server (if present), otherwise to placeholder
        const redirectUrl = data.redirectUrl || 'https://example.com/after-share';
        setTimeout(() => window.location.href = redirectUrl, 700);

      } catch (e) {
        console.error(e);
        msg.textContent = 'Failed: ' + e.message;
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
